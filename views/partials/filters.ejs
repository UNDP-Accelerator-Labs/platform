<% 
	
	// CREATE ALIASES
	const language = locals.metadata.page.language

	if (locals.filters_menu?.length) locals.filters_menu = Object.assign.apply(Object, locals.filters_menu)
	else locals.filters_menu = []
	const query = locals.metadata.page.query

%>

<div id='filters'>
	<% if (query.search?.length) { %>
		<p><%- vocabulary['search terms'][language] %></p>
		<div class='filters-group search-filters'>
			<div class='active-filters'>
				<div class='tag' data-type='Contributor' data-value='<%- query.search %>'>
					<label class='name'>
						<% if (query.search.length > 25) { %>
							<%- query.search.slice(0, 25) %>…
						<% } else { %>
							<%- query.search %>	
						<% } %>
					</label>
					<label class='close'>x</label>
				</div>
			</div>
		</div>
	<% } %>

	<% if (Object.keys(query)?.filter(key => key in locals.filters_menu)?.length) { %>
		<p><%- vocabulary['filter'][language](false, true) %></p>
		<div class='filters-group'>
			<div class='active-filters'>
				<% for (let key in query) { %>
					<% if (key in locals.filters_menu) { %>
						<% query[key].forEach(d => { %>
							<div class='tag' data-type='<%- key %>' data-value='<%- d %>'>
								<% console.log(key.replace(/\_/g, ' ')) %>
								<label class='type'><%- vocabulary[key.replace(/\_/g, ' ').slice(0, -1)][language](false) %></label> 
								<label class='name'>
									<!-- TO DO: FIX PROBLEM HERE WITH SDGS -->
									<% if (locals.filters_menu[key]?.find(c => c.id.toString() === d)?.name.length > 25) { %>
										<%- locals.filters_menu[key]?.find(c => c.id.toString() === d)?.name.slice(0, 25) %>…
									<% } else { %>
										<%- locals.filters_menu[key]?.find(c => c.id.toString() === d)?.name %>	
									<% } %>
								</label>
								<label class='close'>x</label>
							</div>
						<% }) %>
					<% } %>
				<% } %>
			</div>
		</div>
	<% } %>
</div>

<script type='text/javascript'>
	d3.selectAll('nav#filters div.search-filters div.tag label.close')
	.on('click', function () {
		// TO DO: UPDATE THIS
		const sel = d3.select(this)
		const tag = sel.findAncestor('tag')
		const data_value = tag.attr('data-value')

		const search_terms = (<%- JSON.stringify(query.search || []) %>).filter(d => d !== data_value)
		const filter_form = d3.select('nav.browse-filters')
		filter_form.selectAll('input[type=text]').each(function () {
			this.value = search_terms.join(' OR ')
			fixLabel(this)
		})
		filter_form.select('div.submission button.search').node().click()
	})
	d3.selectAll('nav#filters div.filters-group div.tag label.close')
	.on('click', function () {
		// TO DO: UPDATE THIS
		const sel = d3.select(this)
		const tag = sel.findAncestor('tag')
		const data_type = tag.attr('data-type')
		const data_value = tag.attr('data-value')

		const filter_form = d3.select('nav.browse-filters')
		filter_form.selectAll('input[type=checkbox]').filter(function () {
			return d3.select(this).attr('data-type') === data_type && this.value === data_value
		}).node().checked = false
		filter_form.select('div.submission button.search').node().click()
	})

</script>