<%
	// CREATE ALIASES
	const language = locals.metadata.page.language
	const languages = locals.metadata.site.languages
	const page_language = locals.metadata.page.page_language
	const excerpt = locals.metadata.page.excerpt

	const currentpage_url = new URL(locals.metadata.page.currentpage_url?.replace('/edit/', '/view/'))
	const currentpage_query = new URLSearchParams(currentpage_url.search)
	if (excerpt?.p) currentpage_query.append('ogp', true)
	const querylength = [...new Set(currentpage_query.keys())].length
	const url = `${currentpage_url.origin}${currentpage_url.pathname}${querylength ? `?${currentpage_query.toString()}` : ''}`

	const country_page_title = locals.metadata?.page?.instance_title || locals?.pinboard?.title || ''; //COUNTRY INSTANCE TITLE OR COLLECTION TITLE
	const title = `${locals.metadata?.page?.title}${country_page_title ? `: ${country_page_title}` : ''}` //DEFAULT PAGE TITLE => ADD COUNTRY NAME TITLE IF IT EXIST
	
	if (excerpt?.p && excerpt?.img) {
		if (locals.metadata.site.app_storage) {
			excerpt.img.src = new URL(`${locals.metadata.site.app_storage}${excerpt.img.src}`).href
		} 
	} else excerpt.img = { src: `${currentpage_url.origin}/imgs/branding/UNDP_accelerator_labs_logo_vertical_color_opaque.png` }

	if (!excerpt?.p) {
		excerpt.txt = excerpt.txt[language]
	}

	let ogp_locale = 'en_US'
	if(language == 'fr') ogp_locale = 'fr_FR'
	else if (language == 'es') ogp_locale = 'es_ES'
	else if(language == 'pt') ogp_locale = 'pt_PT'
%>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, height=device-height, initial-scale=1.0, target-densitydpi=device-dpi'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta names='apple-mobile-web-app-status-bar-style' content='black-translucent'>
<meta name='theme-color' content='#16a0d6e7'/>

<!-- Facebook Meta Tags -->
<meta property="og:url" content="<%= url %>" >
<meta property="og:type" content="website">
<meta property="og:title" content="<%= excerpt.title %>">
<meta property="og:description" content="<%= excerpt.txt %>">
<meta property="og:image" content="<%= excerpt.img.src %>">
<meta property="og:locale" content="<%= ogp_locale %>">
<meta property="og:image:width" content="<%= excerpt.img.width %>" />
<meta property="og:image:height" content="<%=  excerpt.img.height %>" />

<!-- Twitter Meta Tags -->
<meta property="twitter:url" content="<%= url %>" >
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="<%= excerpt.title %>">
<meta name="twitter:description" content="<%= excerpt.txt %>">
<meta name="twitter:image" content="<%= excerpt.img.src %>">

<title><%- title %></title>

<script type='text/javascript' src='/scripts/d3/dist/d3.min.js'></script>
<script type='text/javascript' src='/scripts/d3-selection-multi/build/d3-selection-multi.min.js'></script>

<script type='text/javascript' src='/scripts/uuid/dist/umd/uuidv4.min.js'></script>

<script type='text/javascript' src='/js/d3.prototype.extensions.js'></script>
<script type='text/javascript' src='/js/String.prototype.extensions.js'></script>
<script type='text/javascript' src='/js/Math.extensions.js'></script>
<script type='text/javascript' src='/js/Array.prototype.extensions.js'></script>
<script type='text/javascript' src='/js/Date.prototype.extensions.js'></script>
<script type='text/javascript' src='/js/basics.js'></script>
<script type='text/javascript' src='/js/upload.js'></script>

<!-- Google Translate CDN -->
<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
<!-- <script src = '/socket.io/socket.io.js'></script> -->

<link rel='stylesheet' href='https://unpkg.com/leaflet@1.6.0/dist/leaflet.css'
	integrity='sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=='
	crossorigin=''/>
<script src='https://unpkg.com/leaflet@1.6.0/dist/leaflet.js'
	integrity='sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=='
	crossorigin=''></script>

<link rel='stylesheet' href='https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined'>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link rel='stylesheet' type='text/css' href='/css/dispatch.css'>

<script type="text/javascript">
	var languageAlias = '<%= page_language %>';
	var googleTranslateElement;
	var languages= ('<%= languages.map(p=> p.language) %>').split(',');
	
	function setCookie(key, value, expiry) {
	  var expires = new Date();
	  expires.setTime(expires.getTime() + (expiry * 24 * 60 * 60 * 1000));
	  document.cookie = key + '=' + value + ';expires=' + expires.toUTCString();
	}
	function googleTranslateElementInit() {
		if(languageAlias !== 'en'){
			setCookie('GoogleAccountsLocale_session', `${languageAlias}`);
			setCookie('googtrans', `/en/${languageAlias}`,1);
		}

		d3.select("#dummy_lang").style("display", "none");
		new google.translate.TranslateElement({
		   pageLanguage: 'en',
		   layout: google.translate.TranslateElement.InlineLayout.SIMPLE
		}, 'google_translate_element');

	}

	function rewriteUrl(lang, reload = false){
		var currentUrl = window.location.href;
		var languagePattern = /\/[a-z]{2,3}\//;
		var newUrl = currentUrl.replace(languagePattern, "/" + lang + "/");

		if(reload) window.location.href = newUrl;
		else window.history.replaceState({}, "", newUrl);
	}

	//IF THE SELECTED LANGUAGE IS ONE OF THE MODULE LANGUAGES, IGNORE GOOGLE TRANSLATE FOR VOCABULARY OBJ
	//THIS MEANS THE SOURCE OF TRUTH FOR TRANSLATION ON MODULE LANGUAGES IS THE VOCABULARY OBJECT.
	function updateDomTree(lang){
		let value = languages.includes(lang) ? 'no' : 'yes'
		d3.selectAll(".google-translate-attr")
  			.attr("translate", value);
	}

	//LISTEN TO CHANGES IN LANGUAGE COOKIES 
	cookieStore.addEventListener('change', ({changed}) => {
		for (const {name, value} of changed) {
			if(name === 'googtrans'){
				var lang = value?.split('/')[2]
				updateDomTree(lang)
				rewriteUrl(lang)
			}
		}
		if(!changed.length){
			rewriteUrl('en', true);
		}
	});

</script>
