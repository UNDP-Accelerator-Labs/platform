<%
    const language = locals.metadata.page.language;
    const vocab = vocabulary['journey'][language];
    const app_db = locals.metadata.site.app_db;
%>
<script type='text/javascript'>
    class Journey {
        constructor() {
            this.past = [];
            this.docs = [];
            this.docLookup = {};
            this.currentId = null;
            this.currentPrompt = '';
            this.mainInput = null;
            this.mainButton = null;
            this.datalist = null;
            this.appDb = '<%- app_db %>';
            if (sessionStorage.journeyId) {
                this.currentId = +sessionStorage.journeyId || null;
            }
            if (sessionStorage.journeyPrompt) {
                this.currentPrompt = this.normalizeJourneyPrompt(sessionStorage.journeyPrompt);
            }
        };

        normalizeJourneyPrompt(prompt) {
            if (!prompt) {
                return '';
            }
            return prompt.replace(/[\s\n\r]+/g, ' ').trim();
        }

        updateCurrentJourney(curId, curPrompt) {
            this.currentId = curId;
            if (curId !== sessionStorage.journeyId) {
                sessionStorage.journeyId = +curId || 0;
            }
            const normPrompt = this.normalizeJourneyPrompt(curPrompt);
            this.currentPrompt = normPrompt;
            if (normPrompt !== sessionStorage.journeyPrompt) {
                sessionStorage.journeyPrompt = normPrompt;
            }
            if (this.mainInput !== null) {
                const mainInput = this.mainInput.node();
                if (mainInput.value !== normPrompt) {
                    mainInput.value = normPrompt;
                }
            }
            this.updateJourneyMainButton(
                this.getJourneyByPrompt(normPrompt)[0],
                curId);
            this.updateJourneyDocs();
        }

        getJourneyById(journeyId) {
            return this.past.reduce((prev, d) => {
                if (d['id'] === journeyId) {
                    return [d['id'], d['prompt']];
                }
                return prev;
            }, [null, '']);
        }

        getJourneyByPrompt(journeyPrompt) {
            const prompt = this.normalizeJourneyPrompt(journeyPrompt);
            return this.past.reduce((prev, d) => {
                if (d['prompt'] === prompt) {
                    return [d['id'], d['prompt']];
                }
                return prev;
            }, [null, prompt]);
        }

        getShortPrompt(journeyId) {
            return this.past.reduce((prev, d) => {
                if (d['id'] === journeyId) {
                    return d['short'];
                }
                return prev;
            }, '');
        }

        updateJourneyMainButton(journeyId, currentId) {
            if (this.mainButton !== null) {
                this.mainButton.text(
                    journeyId === null
                    ? "<%- vocab['start'] %>"
                    : journeyId !== currentId
                    ? "<%- vocab['continue'] %>"
                    : "<%- vocab['finish'] %>");
            }
            if (this.mainInput !== null) {
                const value = this.mainInput.node().value;
                const normPrompt = this.normalizeJourneyPrompt(value);
                this.mainInput.classed('has-value', !!normPrompt);
            }
        }

        updateJourneyDatalist(cb = null) {
            if (!this.datalist) {
                return;
            }
            const datalist = this.datalist;
            GET('/journey/list?lang=<%- language %>').then((result) => {
                const journeys = result['journeys'];
                this.past = journeys;
                const [curId, curPrompt] = this.getJourneyById(this.currentId);
                this.updateCurrentJourney(curId, curPrompt);
                datalist.addElems('option', 'journey-past-elem', journeys)
                .attrs({
                    'value': (d) => this.normalizeJourneyPrompt(d['prompt']),
                    'label': (d) => `<%- vocab['last_access'] %> ${d['last_access_ago']}`,
                });
                cb && cb();
            }).catch((err) => console.error(err));
        }

        updateJourneyDocs() {
            const curId = this.currentId;
            if (!curId) {
                this.docs = [];
                this.docLookup = {};
                this.updateDocs();
                return;
            }
            GET(`/journey/collection?journey_id=${curId}`).then((result) => {
                const docs = result['docs'];
                const newLookup = {};
                const appDb = this.appDb;
                docs.forEach((doc) => {
                    if (doc['db'] !== appDb) {
                        return;
                    }
                    newLookup[`${doc['doc_id']}`] = doc['is_relevant'];
                });
                this.docs = docs;
                this.docLookup = newLookup;
                this.updateDocs();
            })
            .catch((err) => console.error(err));
        }

        isDocApprove(docId) {
            return this.docLookup[`${docId}`] === true;
        }

        isDocDislike(docId) {
            return this.docLookup[`${docId}`] === false;
        }

        confirmJourneyPrompt(allowReport) {
            const mainInput = this.mainInput;
            if (mainInput === null) {
                return;
            }
            const userPrompt = mainInput.node().value;
            const currentId = this.currentId;
            this.updateJourneyDatalist(() => {
                const [curId, curPrompt] = this.getJourneyByPrompt(userPrompt);
                if (curId !== null && curId === currentId) {
                    if (allowReport) {
                        console.log('REPORT!');
                    }
                } else if (curId !== null) {
                    this.updateCurrentJourney(curId, curPrompt);
                } else if (curPrompt) {
                    PUT(`/journey/create`, {
                        'prompt': curPrompt,
                    }).then((result) => {
                        this.updateCurrentJourney(result["journey"], result["prompt"]);
                        this.updateJourneyDatalist();
                    }).catch((err) => console.error(err));
                } else {
                    this.updateCurrentJourney(null, '');
                }
            });
        }

        addJourneyMain(sel) {
            const mainInput = sel.addElem('input')
            .attrs({
                'type': 'text',
                'id': `journey-main`,
                'list': 'journey-past',
            })
            .on('change', () => {
                const value = mainInput.node().value;
                const normPrompt = this.normalizeJourneyPrompt(value);
                this.updateJourneyMainButton(
                    this.getJourneyByPrompt(normPrompt)[0],
                    this.currentId);
            })
            .on('blur', () => this.confirmJourneyPrompt(false));
            this.mainInput = mainInput;
            this.updateCurrentJourney(this.currentId, this.currentPrompt);

            sel.addElem('label')
            .attrs({
                'for': `journey-main`,
            })
            .text("<%- vocab['intro'] %>");
            const datalist = sel.addElem('datalist').attrs({
                'id': 'journey-past',
            });
            this.datalist = datalist;
            const mainButton = sel.addElem('button')
            .attrs({
                'type': 'button',
            })
            .on('click', () => this.confirmJourneyPrompt(true));
            this.mainButton = mainButton;

            this.updateJourneyDatalist();
        }

        updateDocs() {
            const hasJourney = !!this.currentId;
            d3.selectAll('div.journey-doc').styles({
                'display': hasJourney ? null : 'none',
            });
            if (!hasJourney) {
                return;
            }
            const shortPrompt = this.getShortPrompt(this.currentId);
            d3.selectAll('div.journey-doc span span.journey-short')
            .text(`${shortPrompt}`);
            d3.selectAll('button.journey-btn-approve').classed('journey-btn-active', (d) => {
                return this.isDocApprove(d.id);
            });
            d3.selectAll('button.journey-btn-dislike').classed('journey-btn-active', (d) => {
                return this.isDocDislike(d.id);
            });
            d3.selectAll('article.pad').classed('journey-article-inactive', (d) => {
                return this.isDocDislike(d.id);
            });
        }

        setDocAction(docId, isApprove) {
            const journeyId = this.currentId;
            if (!journeyId) {
                return;
            }
            const action = isApprove ? (
                this.isDocApprove(docId) ? 'neutral' : 'approve') : (
                this.isDocDislike(docId) ? 'neutral' : 'dislike');
            PUT('/journey/doc', {
                'doc_id': docId,
                'action': action,
                'journey_id': journeyId,
            }).then((result) => {
                this.updateJourneyDocs();
            }).catch((err) => console.error(err));
        }

        addDocButtons(sel) {
            const doc = sel.addElems('div', 'journey-doc');
            const docSpan = doc.addElem('span');
            docSpan.addElem('span').text("<%- vocab['doc-begin'] %> '");
            docSpan.addElem('span').classed('journey-short', true);
            docSpan.addElem('span').text("': ");
            doc.addElem('button')
            .classed('journey-btn-approve', true)
            .text("<%- vocab['doc-approve'] %>")
            .on('click', (d) => {
                this.setDocAction(d.id, true);
            });
            doc.addElem('button')
            .classed('journey-btn-dislike', true)
            .text("<%- vocab['doc-dislike'] %>")
            .on('click', (d) => {
                this.setDocAction(d.id, false);
            });
            this.updateJourneyDocs();
        }
    } // Journey

    const journey = new Journey();
</script>
