<%
	// CREATE ALIASES
	const publicpage = locals.metadata.page.public
	const modules = locals.metadata.site.modules
	const activity = locals.metadata.page.activity
	const space = locals.metadata.page.space
	const object = locals.metadata.page.object
	const languages = locals.metadata.site.languages
	const language = locals.metadata.page.language
	const rights = locals.metadata.user.rights
	const uuid = locals.metadata.user.uuid
	const pagedisplay = locals.metadata.page.display

	let mapscale = locals.metadata.page.mscale
	// THIS IS FOR PUBLIC PINBOARDS: TO ENSURE THAT THE DEFINED MAP SCALE IS PRESERVED
	if (space === 'pinned' && !locals.pinboard?.editable && locals.pinboard?.display_map) {
		if (locals.pinboard?.display_fullscreen) mapscale = 'full-screen'
		else mapscale = 'contain'
	}

	const { write: writepads } = modules.find(d => d.type === 'pads')?.rights
	let minwritepads = writepads
	if (typeof writepads === 'object') minwritepads = Math.min(writepads.blank, writepads.templated)

	const writablemodules = modules.filter(d => !['pinboards', 'teams'].includes(d.type))
		.map(d => { 
			const { write } = d.rights
			if (typeof write === 'object') return Math.min(write.blank ?? Infinity, write.templated ?? Infinity)
			else return write
		})
%>
<nav id='site-title' class='<% if (publicpage) { %>public<% } %>'>
	<div class='inner'>
		<a href='/'>
			<div class='logo-container'>
				<img class='logo' src='/imgs/branding/UNDP_accelerator_labs_logo_vertical_left_align_color_RGB.png'>
				<div class='filler'></div>
			</div>
		</a>

		<% if (rights >= Math.min(...writablemodules)) { %>
			<div class='create'>
				<button><%- vocabulary['new'][language] %></button>
				<div class='dropdown main'>
					<ul>
						<% if (modules.some(d => d.type === 'pads')) { %>

							<% if (rights >= Math.min(minwritepads ?? Infinity, modules.find(d => d.type === 'moblizations')?.rights.write ?? Infinity)) { %>
								<li>
									<button class="google-translate-attr">
										<img src='/imgs/icons/i-pad.svg'>
										<label><%- vocabulary['pad'][language]['singular'].capitalize() %></label>
										<span class='expandable'>></span>
									</button>
									<div class='dropdown'>
										<ul>
											<% if (rights >= (writepads.blank ?? writepads) ?? Infinity) { %>
											<!-- THE ISSUE HERE IS WE WANT TO PREVENT USERS OF THE experiments AND action plans PLATFORMS FROM CREATING BLANK PADS -->
												<li class="google-translate-attr">
													<a href='/<%- language %>/contribute/pad'>
			 											<button>
															<label><%- vocabulary['blank pad'][language] %></label>
														</button>
													</a>
												</li>
											<% } // rights %>
											<% if (rights >= (writepads.templated ?? writepads) ?? Infinity) { %>
												<% if (locals.metadata.menu.templates?.length > 0) { %>
													<li class="google-translate-attr">
														<button>
															<label><%- vocabulary['templated pad'][language] %></label>
															<span class='expandable'>></span>
														</button>
														<div class='dropdown leaf'>
															<ul>
																<% if (locals.metadata.menu.templates.length > 2) { %>
																	<li class='filter xs sm m lg xl xxl'>
																		<input type='text' id='filter-pad-templates' onblur='fixLabel(this)' onkeyup='filterDropdown(this)'>
																		<label for='filter-pad-templates'><%- vocabulary['filter'][language](true) %></label>
																	</li>
																	<li class='padding'></li>
																<% } // locals.metadata.menu.templates 2 %>
																<% locals.metadata.menu.templates.forEach(t => { %>
																	<li class='status-<%- t.status %>'>
																		<a href='/<%- language %>/contribute/pad?template=<%- t.id %>'>
																			<% if (t.title) { %>
																				<button class='wrapable'>
																					<label><%- t.title %></label>
																					<% if (t.owner !== uuid) { %>
																						<div class='sub'>
																							<%- vocabulary['created by'][language](t.ownername) %>
																						</div>
																					<% } // t.owner %>
																				</button>
																			<% } else { // t.title %>
																				<button class='wrapable'>
																					<label>[<%- vocabulary['untitled template'][language] %>]</label>
																					<% if (t.owner !== uuid) { %>
																						<div class='sub'>
																							<%- vocabulary['created by'][language](t.ownername) %>
																						</div>
																					<% } // t.owner %>
																				</button>
																			<% } // t.title %>
																		</a>
																	</li>
																<% }) // locals.metadata.menu.templates.forEach %>
															</ul>
														</div>
													</li>
												<% } // locals.metadata.menu.templates 0 %>
											<% } // rights %>
											<% if (locals.metadata.menu.participations?.filter(p => !(p.source && !p.copy) || p.child).length > 0) { %>
												<li class="google-translate-attr">
													<button>
														<label><%- vocabulary['campaign pad'][language] %></label>
														<span class='expandable'>></span>
													</button>
													<div class='dropdown leaf'>
														<ul>
															<% if (locals.metadata.menu.participations
															.filter(p => (!(p.source && !p.copy) || p.child) && p.status === 1).length > 2) { %>
																<li class='filter xs sm m lg xl xxl'>
																	<input type='text' id='filter-pad-mobilizations' onblur='fixLabel(this)' onkeyup='filterDropdown(this)'>
																	<label for='filter-pad-mobilizations'><%- vocabulary['filter'][language](true) %></label>
																</li>
																<li class='padding'></li>
															<% } %>
															<% locals.metadata.menu.participations
															.filter(p => (!(p.source && !p.copy) || p.child) && p.status === 1)
															.forEach(d => { %>
																<li>
																	<a href='/<%- language %>/contribute/pad?mobilization=<%- d.id %>&template=<%- d.template %>'>
																		<button class='wrapable'>
																			<label><%- d.title %></label>
																			<div class='sub'>
																				<% if (d.owner !== uuid) { %>
																					<%= vocabulary['launched by'][language] %> <%= d.ownername %> <%= vocabulary['on'][language] %> <%= new Date(d.start_date).toLocaleDateString(language, { year: 'numeric', month: 'long', day: 'numeric' }) %>
																				<% } else { %>
																					<%= vocabulary['launched on'][language] %> <%= new Date(d.start_date).toLocaleDateString(language, { year: 'numeric', month: 'long', day: 'numeric' }) %>
																				<% } %>
																			</div>
																		</button>
																	</a>
																</li>
															<% }) %>
														</ul>
													</div>
												</li>
											<% } %>
											<!-- IF WE WANT xlsx FUNCTIONALITY FOR MOBILIZATIONS, UNCOMMENT THE FOLLOWING -->
											<!-- <%# if (rights >= (modules.find(d => d.type === 'mobilizations')?.rights.write ?? Infinity)	|| locals.metadata.menu.participations.filter(p => !p.source).length > 0) { %> -->

											<% if (rights >= (writepads.blank ?? writepads) ?? Infinity) { %>
												<li class='lg xl xxl google-translate-attr'>
													<a href='/<%- language %>/import/pads'>
														<button><%- vocabulary['import pads'][language] %></button>
													</a>
												</li>
											<% } %>
										</ul>
									</div>
								</li>
							<% } %>
						<% } %>
						<% if (modules?.some(d => d.type === 'templates')) { %>
							<% if (rights >= (modules.find(d => d.type === 'templates')?.rights.write ?? Infinity)) { %>
								<li class="google-translate-attr">
									<button>
										<img src='/imgs/icons/i-template.svg'>
										<label><%- vocabulary['template'][language]['singular'].capitalize() %></label>
										<span class='expandable'>></span>
									</button>
									<div class='dropdown'>
										<ul>
											<li>
												<a href='/<%- language %>/contribute/template'>
													<button>
														<label><%- vocabulary['blank template'][language] %></label>
													</button>
												</a>
											</li>
											<% if (locals.metadata.menu.templates?.length > 0) { %>
												<li>
													<button>
														<label><%- vocabulary['copy template'][language] %></label>
														<span class='expandable'>></span>
													</button>
													<div class='dropdown leaf'>
														<ul>
															<% if (locals.metadata.menu.templates.length > 2) { %>
																<li class='filter xs sm m lg xl xxl'>
																	<input type='text' id='filter-templates-copy' onblur='fixLabel(this)' onkeyup='filterDropdown(this)'>
																	<label for='filter-templates-copy'><%- vocabulary['filter'][language](true) %></label>
																</li>
																<li class='padding'></li>
															<% } %>
															<% locals.metadata.menu.templates.forEach(t => { %>
																<li class='status-<%- t.status %>'>
																	<a href='/<%- language %>/contribute/template?source=<%- t.id %>'>
																		<% if (t.title) { %>
																			<button class='wrapable'>
																				<label><%- t.title %></label>
																				<% if (t.owner !== uuid) { %>
																					<div class='sub'>
																						<%- vocabulary['created by'][language](t.ownername) %>
																					</div>
																				<% } %>
																			</button>
																		<% } else { %>
																			<button class='wrapable'>
																				<label>[<%- vocabulary['untitled template'][language] %>]</label>
																				<% if (t.owner !== uuid) { %>
																					<div class='sub'>
																						<%- vocabulary['created by'][language](t.ownername) %>
																					</div>
																				<% } %>
																			</button>
																		<% } %>
																	</a>
																</li>
															<% }) %>
														</ul>
													</div>
												</li>
											<% } %>
											<% if (modules?.some(d => d.type === 'reviews'
												&& (rights >= d.rights.coordinate || rights > 2)
											)) { %>
												<li>
													<button>
														<label><%- vocabulary['review template'][language] %></label>
														<span class='expandable'>></span>
													</button>
													<div class='dropdown leaf'>
														<ul>
															<!-- TO DO: FINISH THIS WITH A FILTER MENU -->
															<!-- <% if (locals.metadata.menu.templates.length > 2) { %>
																<li class='filter xs sm m lg xl xxl'>
																	<input type='text' id='filter-templates-copy' onblur='fixLabel(this)' onkeyup='filterDropdown(this)'>
																	<label for='filter-templates-copy'><%- vocabulary['filter'][language](true) %></label>
																</li>
																<li class='padding'></li>
															<% } %> -->
															<% languages.forEach(d => { %>
																<% if (!locals.metadata.menu.review_templates.some(c => c.language === d.language)) { %>
																	<a href='/<%- language %>/contribute/template?review_template=true&language=<%- d.language %>'>
																		<li>
																			<button><label><%- d.name %></label></button>
																			<!-- TO DO: TRANSLATE LANGUAGE NAMES (e.g. FRENCH > FRANÇAIS) -->
																		</li>
																	</a>
																<% } else { %>
																	<li>
																		<button><label><%- d.name %></label></button>
																		<!-- TO DO: TRANSLATE LANGUAGE NAMES (e.g. FRENCH > FRANÇAIS) -->
																	</li>
																<% } %>
															<% }) %>
														</ul>
													</div>
												</li>
											<% } %>
										</ul>
									</div>
								</li>
							<% } %>
						<% }%>
						<!-- IF WE WANT TO UPLOAD FILES FOR MOBILIZATIONS, UNCOMMENT THE FOLLOWING -->
						<% if (locals.metadata?.site?.modules?.some(d => d.type === 'files')) { %>
							<!-- <%# if (rights >= (modules.find(d => d.type === 'files')?.rights.write ?? Infinity) || locals.metadata.menu.participations.filter(p => !p.source).length > 0) { %> -->
							<% if (rights >= (modules.find(d => d.type === 'files')?.rights.write ?? Infinity)) { %>
								<li>
									<form action='/upload/file' method='POST' enctype='multipart/form-data'>
										<img src='/imgs/icons/i-pad.svg'>
										<input type='file' id='input-file-all' name='file' accept='application/pdf, image/*,video/*,audio/*' onchange='uploadFile(this.form, "<%- language %>")' multiple>
										<label for='input-file-all' title='Upload a file.'><%- vocabulary['file'][language](false) %></label>
									</form>
								</li>
							<% } %>
						<% } %>
						<% if (locals.metadata?.site?.modules?.some(d => d.type === 'contributors')) { %>
							<% if (rights >= (modules.find(d => d.type === 'contributors')?.rights.write ?? Infinity)) { %>
								<li class="google-translate-attr">
									<a href='/<%- language %>/contribute/contributor'>
										<button>
											<img src='/imgs/icons/i-contributor.svg'>
											<label><%- vocabulary['contributor'][language]['singular'].capitalize() %></label>
										</button>
									</a>
								</li>
							<% } %>
						<% } %>

						<% if (locals.metadata?.site?.modules?.some(d => d.type === 'mobilizations')) { %>
							<% if (rights >= (modules.find(d => d.type === 'mobilizations')?.rights.write ?? Infinity)) { %>
								<li class="google-translate-attr">
									<button>
										<img src='/imgs/icons/i-mobilization.svg'>
										<label><%- vocabulary['mobilization'][language]['singular'].capitalize() %></label>
										<span class='expandable'>></span>
									</button>
									<div class='dropdown'>
										<ul>
											<li>
												<a href='/<%- language %>/mobilize/cohort'>
													<button>
														<label>
															<%- vocabulary['call for contributions'][language] %>
														</label>
													</button>
												</a>
											</li>
											<% if (locals.metadata.menu.pinboards?.length > 0) { %>
												<li>
													<button>
														<label>Depth campaign</label>
														<!-- TO DO: TRANSLATE -->
														<span class='expandable'>></span>
													</button>

													<div class='dropdown leaf'>
														<ul>
															<% if (locals.metadata.menu.pinboards.length > 2) { %>
																<li class='filter xs sm m lg xl xxl'>
																	<input type='text' id='filter-deep-dive-pinbords' onblur='fixLabel(this)' onkeyup='filterDropdown(this)'>
																	<label for='filter-deep-dive-pinbords'><%- vocabulary['filter'][language](true) %></label>
																</li>
																<li class='padding'></li>
															<% } %>
															<% locals.metadata.menu.pinboards.forEach(d => { %>
																<li class='status-<%- d.status %>'>
																	<!-- TO DO: REROUTE THIS -->
																	<a href='/<%- language %>/mobilize/cohort?pinboard=<%- d.id %>'>
																		<button class='wrapable'>
																			<label><%- d.title %></label>
																			<div class='sub'>
																				<%- d.size %> pads from <%- d.contributors %> contributors
																				<!-- TO DO: TRANSLATE -->
																			</div>
																		</button>
																	</a>
																</li>
															<% }) %>
														</ul>
													</div>
												</li>
											<% } %>

											<% if (locals.metadata.menu.mobilizations?.filter(d => !d.target_id).length > 0) { %>
												<li>
													<button>
														<label><%- vocabulary['followup mobilization'][language] %></label>
														<span class='expandable'>></span>
													</button>
													<div class='dropdown leaf'>
														<ul>
															<% if (locals.metadata.menu.mobilizations.filter(d => !d.target_id).length > 2) { %>
																<li class='filter xs sm m lg xl xxl'>
																	<input type='text' id='filter-mobilization-followup' onblur='fixLabel(this)' onkeyup='filterDropdown(this)'>
																	<label for='filter-mobilization-followup'><%- vocabulary['filter'][language](true) %></label>
																</li>
																<li class='padding'></li>
															<% } %>
															<% locals.metadata.menu.mobilizations.filter(d => !d.target_id)
															.forEach(d => { %>
																<li class='status-<%- d.status %>'>
																	<a href='/<%- language %>/mobilize/cohort?source=<%- d.id %>'>
																		<button class='wrapable'>
																			<label><%- d.title %></label>
																			<div class='sub'>
																				<% if (d.owner !== uuid) { %>
																					<%= vocabulary['launched by'][language] %> <%= d.ownername %>
																				<% } %>
																			</div>
																		</button>
																	</a>
																</li>
															<% }) %>
														</ul>
													</div>
												</li>
											<% } %>
											<% if (locals.metadata.menu.mobilizations?.length > 0) { %>
												<li>
													<button>
														<label><%- vocabulary['copy mobilization'][language] %></label>
														<span class='expandable'>></span>
													</button>
													<div class='dropdown leaf'>
														<ul>
															<% if (locals.metadata.menu.mobilizations.length > 2) { %>
																<li class='filter xs sm m lg xl xxl'>
																	<input type='text' id='filter-mobilization-copy' onblur='fixLabel(this)' onkeyup='filterDropdown(this)'>
																	<label for='filter-mobilization-copy'><%- vocabulary['filter'][language](true) %></label>
																</li>
																<li class='padding'></li>
															<% } %>
															<% locals.metadata.menu.mobilizations.forEach(d => { %>
																<li>
																	<a href='/<%- language %>/mobilize/cohort?copy=true&source=<%- d.id %>'>
																		<button class='wrapable'>
																			<label><%- d.title %></label>
																			<div class='sub'>
																				<% if (d.owner !== uuid) { %>
																					<%= vocabulary['launched by'][language] %> <%= d.ownername %>
																				<% } %>
																			</div>
																		</button>
																	</a>
																</li>
															<% }) %>
														</ul>
													</div>
												</li>
											<% } %>
											<% if (locals.metadata.menu.participations?.filter(d => !(d.source && !d.copy) && !d.child).length > 0) { %>
												<li>
													<!-- CANNOT DISTRIBUTE A FOLLOW UP MOBILIZATION -->
													<button>
														<label><%- vocabulary['expand mobilization'][language] %></label>
														<span class='expandable'>></span>
													</button>
													<div class='dropdown leaf'>
														<ul>
															<% if (locals.metadata.menu.participations
															.filter(d => !(d.source && !d.copy) && d.status === 1 && !d.child).length > 2) { %>
																<li class='filter xs sm m lg xl xxl'>
																	<input type='text' id='filter-mobilization-child' onblur='fixLabel(this)' onkeyup='filterDropdown(this)'>
																	<label for='filter-mobilization-child'><%- vocabulary['filter'][language](true) %></label>
																</li>
																<li class='padding'></li>
															<% } %>
															<% locals.metadata.menu.participations
															.filter(d => !(d.source && !d.copy) && d.status === 1 && !d.child)
															.forEach(d => { %>
																<li>
																	<a href='/<%- language %>/mobilize/cohort?child=true&source=<%- d.id %>'>
																		<button class='wrapable'>
																			<label><%- d.title %></label>
																			<div class='sub'>
																				<% if (d.owner !== uuid) { %>
																					<%= vocabulary['launched by'][language] %> <%= d.ownername %> <%= vocabulary['on'][language] %> <%= new Date(d.start_date).toLocaleDateString(language, { year: 'numeric', month: 'long', day: 'numeric' }) %>
																				<% } else { %>
																					<%= vocabulary['launched on'][language] %> <%= new Date(d.start_date).toLocaleDateString(language, { year: 'numeric', month: 'long', day: 'numeric' }) %>
																				<% } %>
																			</div>
																		</button>
																	</a>
																</li>
															<% }) %>
														</ul>
													</div>
												</li>
											<% } %>

										</ul>
									</div>
								</li>
							<% } %>
						<% } %>
						<% if (locals.metadata?.site?.modules?.includes('analyses')) { %>
							<% if (rights >= (modules.find(d => d.type === 'analyses')?.rights.write ?? Infinity)) { %>
								<li class="google-translate-attr">
									<button>
										<label><%- vocabulary['analyse']?.[language](false, false)?.capitalize() || 'Analysis' %></label>
										<span class='expandable'>></span>
									</button>
								</li>

							<% } %>
						<% } %>
					</ul>
				</div>
			</div>
		<% } %>
		<h1 ><%- (locals.metadata.site.title).replace(/\s+/g, '<br>') %></h1>
		<% if (!publicpage) { %>
			<h2>
				<% if (locals.metadata.user.country.iso3 === 'NUL') { %>Global
				<% } else { %><%- locals.metadata.user.country.name %><% } %>
			</h2>
		<% } %>

		<% if (['contribute', 'edit'].includes(activity)) { %>
			<div class='save lg xl xxl hide google-translate-attr'>
				<button><%- vocabulary['save'][language] %></button>
			</div>
		<% } %>
	</div>
</nav>
<nav id='modules'>
	<menu class="google-translate-attr">
	<% modules.filter(d => {
		let { write } = d.rights
		if (typeof write === 'object') write = Math.min(write.blank ?? Infinity, write.templated ?? Infinity)

		if (rights < write) return false
		else return !['pinboards', 'teams'].includes(d.type)
	}).forEach(d => { %>
		<% if (['browse', 'view', 'contribute', 'edit', 'import'].includes(activity)
			&& [d.type, d.type.slice(0, -1)].includes(object)
		) { %>
			<li class='active'>
		<% } else { %>
			<li>
		<% } %>
			<% if (d.type === 'mobilizations') { %>
				<a href='/<%- language %>/browse/<%- d.type %>/ongoing'><%- vocabulary[d.type.slice(0, -1)]?.[language]['plural']?.capitalize() || d.type.capitalize() %></a>
			<% } else if (d.type === 'contributors') { %>
				<a href='/<%- language %>/browse/<%- d.type %>/invited'><%- vocabulary[d.type.slice(0, -1)]?.[language]['plural']?.capitalize() || d.type.capitalize() %></a>
			<% } else if (d.type === 'reviews') { %>
				<a href='/<%- language %>/browse/<%- d.type %>/pending'><%- vocabulary["review"][language]["plural"]?.capitalize() %></a>
			<% } 
			else { %>
				<a href='/<%- language %>/browse/<%- d.type %>/private'><%- vocabulary[d.type.slice(0, -1)]?.[language]['plural']?.capitalize() || d.type.capitalize() %></a>
			<% } %>
		</li>
	<% }) %>
	</menu>
</nav>
<nav class='pagination <% if (pagedisplay === "slideshow") { %>xs sm m <% } %>lg xl xxl'>
	<% if ((activity === 'browse' || locals.instance_vars?.activity === 'browse') && mapscale !== 'full-screen') { %>
		<%- include('../../browse/modules/pagination') %>
	<% } %>
</nav>