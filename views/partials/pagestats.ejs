<%
    const originalUrl = locals.metadata.page.originalUrl;
    const { id, docType } = locals.metadata?.user?.pagestats ?? {};
    const readTime = 6000;  // time it takes to register a read in milliseconds
    const docTypes = ['pad', 'template', 'pinboard', 'team', 'country'];
%>
<% if (docTypes.includes(docType) && id) { %>
<script type="text/javascript" defer>
    const totalTime = <%- readTime %>;
    const docId = <%= id %>;
    const docType = '<%= docType %>';
    const pageURL = '<%= originalUrl %>';
    let startTime = performance.now();
    let currentProgress = 0;
    let active = true;
    let done = false;

    const recordRead = () => {
        if (active) {
            currentProgress += performance.now() - startTime;
            startTime = performance.now();
            if (currentProgress >= totalTime) {
                POST('/pagestats', { doc_id: docId, doc_type: docType, page_url: pageURL }).then(() => {
                    // done
                }).catch((e) => {
                    console.log(e);
                });
                done = true;
            }
        }
        if (!done) {
            setTimeout(recordRead, Math.max(1, Math.min(totalTime - currentProgress, 1000)));
        }
    };

    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            if (active) {
                currentProgress += performance.now() - startTime;
            }
            active = false;
        } else {
            if (!active) {
                startTime = performance.now();
            }
            active = true;
        }
    });
    setTimeout(recordRead, 1000);
</script>
<% } // is allowed type and has id %>
