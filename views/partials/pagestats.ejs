<%
    const object = locals.metadata.page.object;
    const originalUrl = locals.metadata.page.originalUrl;
    const { id } = locals.data;
    const readTime = 6000;  // time it takes to register a read in milliseconds
    const docMap = {
        'pad': 'pad',
        'template': 'template',
    };
    const docType = docMap[`${object}`];
%>
<% if (docType && id) { %>
<script type="text/javascript" defer>
    const totalTime = <%- readTime %>;
    const docId = <%= id %>;
    const docType = '<%= docType %>';
    const pageURL = '<%= originalUrl %>';
    let startTime = performance.now();
    let currentProgress = 0;
    let active = true;
    let done = false;

    const recordRead = () => {
        if (active) {
            currentProgress += performance.now() - startTime;
            startTime = performance.now();
            if (currentProgress >= totalTime) {
                POST('/pagestats', { doc_id: docId, doc_type: docType, page_url: pageURL }).then(() => {
                    // done
                }).catch((e) => {
                    console.log(e);
                });
                done = true;
            }
        }
        if (!done) {
            setTimeout(recordRead, Math.max(1, Math.min(totalTime - currentProgress, 1000)));
        }
    };

    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            if (active) {
                currentProgress += performance.now() - startTime;
            }
            active = false;
        } else {
            if (!active) {
                startTime = performance.now();
            }
            active = true;
        }
    });

    setTimeout(recordRead, 1000);
    ensureIcon('.engagement-reads-icon', '/imgs/icons/i-eye.svg', '/imgs/icons/i-eye-closed.svg', 200, 2000);
</script>
<% } // is allowed type and has id %>
